name: Test Release (TestPyPI)

on:
  push:
    tags:
      - 'v*rc*'
      - 'v*dev*'
      - 'v*a*'
      - 'v*b*'
  workflow_dispatch:

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU (Linux aarch64 emulation)
      if: runner.os == 'Linux'
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Build wheels
      uses: pypa/cibuildwheel@v2.22
      env:
        CIBW_BUILD: "cp310-* cp311-* cp312-* cp313-* cp314-*"
        CIBW_SKIP: "*-win32 *-manylinux_i686 *-musllinux_*"
        CIBW_ARCHS_LINUX: "x86_64 aarch64"
        CIBW_ARCHS_MACOS: "x86_64 arm64"
        CIBW_ARCHS_WINDOWS: "AMD64"
        CIBW_ENVIRONMENT: "CIBUILDWHEEL=1"
        CIBW_BUILD_VERBOSITY: 1
        CIBW_TEST_REQUIRES: "pytest numpy pandas matplotlib scipy statsmodels"
        CIBW_TEST_COMMAND: "pytest {project}/tests -v -x --ignore={project}/tests/backend/ -m 'not slow'"

    - name: Verify native extension in wheels
      run: |
        for whl in ./wheelhouse/*.whl; do
          echo "Checking $whl..."
          if unzip -l "$whl" | grep -q "mcpower_native"; then
            echo "  Native extension found."
          else
            echo "::error::Native extension (mcpower_native) missing from $whl"
            exit 1
          fi
        done

    - uses: actions/upload-artifact@v4
      with:
        name: wheels-${{ matrix.os }}
        path: ./wheelhouse/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Build sdist
      run: |
        python -m pip install build
        python -m build --sdist

    - uses: actions/upload-artifact@v4
      with:
        name: sdist
        path: dist/*.tar.gz

  publish-testpypi:
    name: Publish to TestPyPI
    needs: [build_wheels, build_sdist]
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      id-token: write

    steps:
    - uses: actions/download-artifact@v4
      with:
        path: dist/

    - name: Flatten artifacts
      run: |
        mkdir -p dist-flat
        find dist/ -name "*.whl" -exec cp {} dist-flat/ \;
        find dist/ -name "*.tar.gz" -exec cp {} dist-flat/ \;
        echo "Files to upload:"
        ls -la dist-flat/

    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        repository-url: https://test.pypi.org/legacy/
        packages-dir: dist-flat/

    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Smoke test from TestPyPI
      run: |
        PKG_VERSION=$(python -c "
        import re
        with open('pyproject.toml') as f:
            content = f.read()
        match = re.search(r'version\s*=\s*\"([^\"]+)\"', content)
        print(match.group(1))
        ")
        echo "Waiting for TestPyPI to index version $PKG_VERSION..."
        sleep 30
        pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ "MCPower==$PKG_VERSION"
        python -c "import mcpower; print(f'TestPyPI install OK: {mcpower.__version__}')"
